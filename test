<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการข้อมูลแผนการเรียน</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link href="styles.css" rel="stylesheet">
    <style>
    .content {
        display: flex;
        flex-direction: column;
        align-items: left;
    }

    h3.text-primary {
        text-align: center;
        margin-top: 50px;
    }

    .card {
        width: 100%;
    }

    .container {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .dropdown-container {
        display: flex;
        gap: 20px;

        /* Ensure full width to enable centering */
    }

    .dropdown-custom {
        font-size: 18px;
    }

    .academic-year-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .arrow {
        background-color: transparent;
        border: none;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        padding: 10px;
        color: #000000;
    }

    .arrow:hover {
        color: #0056b3;
    }

    .button-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        /* Adds space between buttons */
        margin: 20px 0;
    }
    .btn-clear {
        background-color: #dc3545; 
        color: #fff;
        font-size: 18px;
    }
    </style>
</head>

<body>
    <div class="content-wrapper">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="text-primary">จัดการข้อมูลแผนการเรียน</h1>
                    </div>
                    <div class="col-sm-6">
                        <div class="header-buttons">
                            <a href="subject_add.php" class="btn btn-primary">เพิ่มข้อมูลแผนการเรียน</a>
                            <button class="btn btn-info ml-2" id="export-btn">
                                <i class="fas fa-file-excel"></i> ดาวน์โหลด Excel
                            </button>
                            <form id="upload-form" action="subject.php" method="POST" enctype="multipart/form-data">
                                <label class="custom-file-upload ml-2">
                                    <input type="file" name="upload-file" id="upload-file" accept=".xlsx, .xls">
                                    <i class="fas fa-file-upload"></i> อัปโหลด Excel
                                </label>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <div class="container dropdown-container">
            <div class="dropdown">
                <button class="btn btn-custom dropdown-toggle" type="button" id="yearDropdown" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    เลือกปีการศึกษา
                </button>
                <div class="dropdown-menu" aria-labelledby="yearDropdown">
                    <a class="dropdown-item" href="#" onclick="selectYear(2567)">2567</a>
                    <a class="dropdown-item" href="#" onclick="selectYear(2568)">2568</a>
                    <a class="dropdown-item" href="#" onclick="selectYear(2569)">2569</a>
                    <a class="dropdown-item" href="#" onclick="selectYear(2570)">2570</a>
                    <a class="dropdown-item" href="#" onclick="selectYear(2571)">2571</a>
                </div>
            </div>

            <div class="dropdown">
                <button class="btn btn-custom dropdown-toggle" type="button" id="classDropdown" data-toggle="dropdown"
                    aria-haspopup="true" aria-expanded="false">
                    เลือกระดับชั้น
                </button>
                <div class="dropdown-menu" aria-labelledby="classDropdown">
                    <a class="dropdown-item" href="#" onclick="selectClass('ปวช.1')">ปวช1</a>
                    <a class="dropdown-item" href="#" onclick="selectClass('ปวช.2')">ปวช2</a>
                    <a class="dropdown-item" href="#" onclick="selectClass('ปวช.3')">ปวช3</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" onclick="selectClass('ปวส.1')">ปวส1</a>
                    <a class="dropdown-item" href="#" onclick="selectClass('ปวส.2')">ปวส2</a>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="btn btn-success" id="fetch-btn"><i class="fas fa-search"></i> ดูข้อมูลแผนการเรียน</button>
            <button class="btn btn-clear" id="clear-btn"><i class="fas fa-times"></i> clear</button>
        </div>

        <section class="content">
            <div id="subject-container"></div>
        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script>
    let selectedYear = null;
    let selectedClass = null;

    function selectYear(year) {
        selectedYear = year;
        $('#yearDropdown').text(`ปีการศึกษา ${year}`);
    }

    function selectClass(classYear) {
        selectedClass = classYear;
        $('#classDropdown').text(`ระดับชั้น ${classYear}`);
    }

    function updateSubjectContainer() {
        if (selectedYear && selectedClass) {
            $.ajax({
                url: '../fetch/get_studyplan.php',
                method: 'GET',
                data: {
                    class_year: selectedClass,
                    school_year: selectedYear
                },
                dataType: 'json',
                success: function(response) {
                    if (response.status === 'no_data') {
                        $('#subject-container').html(
                            `<p style="font-size: 30px; font-weight: bold; color: #dc3545; text-align: center; margin-top: 40px;">
                                ไม่พบแผนการเรียน ระดับชั้น ${response.class_year} ปีการศึกษา ${response.school_year}
                            </p>`
                        );
                    } else if (response.status === 'success') {
                        $('#subject-container').html(renderSubjectData(response.data));
                        // Initialize DataTables after loading new content
                        $('#subject-table-1').DataTable({
                            paging: false,
                            info: false,
                            searching: false
                        });
                        $('#subject-table-2').DataTable({
                            paging: false,
                            info: false,
                            searching: false
                        });
                    }
                }
            });
        } else if (!selectedYear && !selectedClass) {
            Swal.fire('กรุณาเลือกปีการศึกษาและระดับชั้นก่อนนะครับ');
        } else if (!selectedYear) {
            Swal.fire('กรุณาเลือกปีการศึกษา');
        } else if (!selectedClass) {
            Swal.fire('กรุณาเลือกระดับชั้น');
        }
    }

    function renderSubjectData(data) {
        let html = '';
        for (const major_name in data) {
            for (const field_of_work_name in data[major_name]) {
                html += `<h3 class='text-primary'>${major_name} ${field_of_work_name}</h3>`;
                for (let semester = 1; semester <= 2; semester++) {
                    html += `<div class='container mt-4'>
                            <div class='card border-primary'>
                                <div class='card-body'>
                                    <h5>ภาคเรียนที่ ${semester}</h5>
                                    <table id='subject-table-${semester}' class='table table-bordered table-striped table-hover'>
                                        <thead class='thead-dark'>
                                            <tr>
                                                <th width='15%' class='text-center'>รหัสวิชา</th>
                                                <th width='25%' class='text-center'>ชื่อวิชา</th>
                                                <th width='15%' class='text-center'>หน่วยกิต</th>
                                                <th width='15%' class='text-center'>รหัสสาขา</th>
                                                <th width='5%' class='text-center'>แก้ไข</th>
                                                <th width='5%' class='text-center'>ลบ</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;
                    if (data[major_name][field_of_work_name][semester]) {
                        for (const subject of data[major_name][field_of_work_name][semester]) {
                            html += `<tr>
                                    <td class='text-center'>${subject.subject_id}</td>
                                    <td>${subject.subject_name}</td>
                                    <td class='text-center'>${subject.num_credits}</td>
                                    <td class='text-center'>${subject.major_id}</td>
                                    <td class='text-center'>
                                        <a href='#' class='btn btn-warning btn-sm'>
                                            <i class='fas fa-edit'></i>
                                        </a>
                                    </td>
                                    <td class='text-center'>
                                        <a href='#' class='btn btn-danger btn-sm delete-button'>
                                            <i class='fas fa-trash-alt'></i>
                                        </a>
                                    </td>
                                </tr>`;
                        }
                    } else {
                        html += "<tr><td colspan='6' class='text-center'>ไม่พบข้อมูล</td></tr>";
                    }
                    html += `</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
                }
            }
        }
        return html;
    }

    // Add event listener to the fetch button
    $('#fetch-btn').on('click', function() {
        updateSubjectContainer();
    });

    // Add event listener to the clear button
    $('#clear-btn').on('click', function() {
        selectedYear = null;
        selectedClass = null;
        $('#yearDropdown').text('เลือกปีการศึกษา');
        $('#classDropdown').text('เลือกระดับชั้น');
        $('#subject-container').empty();
    });
    </script>
</body>

</html>


//get_studyplan.php
<?php
include('../config/connect.php');

$class_year = $_GET['class_year'] ?? '';
$school_year = $_GET['school_year'] ?? '';

$stmt = $condb->prepare("
    SELECT 
        major.major_name AS major_name,
        major.field_of_work_name AS field_of_work_name,
        study_plan.semester AS semester,
        subject.subject_id AS subject_id,
        subject.subject_name AS subject_name,
        CONCAT(subject.num_credits , '(', subject.total_class_hours, '-', subject.theory_hours, '-', subject.hours_of_practice, ')') AS num_credits,
        subject.major_id AS major_id
    FROM 
        study_plan
    JOIN 
        major ON study_plan.major_id = major.major_id
    JOIN 
        subject ON study_plan.subject_id = subject.subject_id
    WHERE 
        study_plan.class_year = :class_year
        AND study_plan.school_year = :school_year
");

$stmt->execute(['class_year' => $class_year, 'school_year' => $school_year]);

$results = $stmt->fetchAll(PDO::FETCH_ASSOC);

if (empty($results)) {
    echo json_encode(['status' => 'no_data', 'class_year' => $class_year, 'school_year' => $school_year]);
} else {
    $data = [];
    foreach ($results as $row) {
        $data[$row['major_name']][$row['field_of_work_name']][$row['semester']][] = $row;
    }
    // Output the data in a format suitable for the front-end
    // You can use json_encode($data) or any other format you prefer
    echo json_encode(['status' => 'success', 'data' => $data]);
}
?>
