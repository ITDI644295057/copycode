<!-- Content Wrapper. Contains page content -->

<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <!-- Dashboard title removed -->
                </div><!-- /.col -->
                <div class="col-sm-6 text-right" style="padding-right: 15px;">
                    <br>
                    <h1 class="m-0" id="currentDateTime"></h1>
                </div><!-- /.col -->
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Image placed below date and time -->
    <div class="text-center mb-4">
        <img src="../assets/dist/img/header.png" alt="Header Image" style="max-width: 100%; height: auto;">
    </div>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Small boxes (Stat box) -->
            <div class="row">
                <!-- Small boxes (statistic) -->
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3 id="total-deposits" class="large-text">0</h3>
                            <p class="medium-text">จำนวนนักศึกษาทั้งหมด(คน)</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3 id="total-withdrawals" class="large-text">0</h3>
                            <p class="medium-text">จำนวนนักศึกษาลงทะเบียน(คน)</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3 id="total-borrowings" class="large-text">0</h3>
                            <p class="medium-text">จำนวนนักศึกษาชำระเงิน(คน)</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-money-check-alt"></i>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-6">
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3 id="total-balance" class="large-text">0</h3>
                            <p class="medium-text">จำนวนเงินชำระค่าเทอม(บาท)</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Section with Chart.js -->
            <div class="container-fluid mt-4">
                <div class="row">
                    <!-- First chart -->
                    <div class="col-lg-6 col-md-12">
                        <div class="card" style="height: 100%;">
                            <div class="card-body">
                                <h3 class="card-title text-center" id="studentChartTitle">กราฟจำนวนนักศึกษาลงทะเบียน
                                </h3><br><br>

                                <!-- Dropdown for academic year -->
                                <label for="academicYear"> เลือกปีการศึกษา:</label>
                                <select id="academicYear" onchange="updateChart()">
                                    <option value="2567">2567</option>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                </select>
                                <canvas id="studentChart" style="width: 100%; height: 400px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Second chart -->
                    <div class="col-lg-6 col-md-12">
                        <div class="card" style="height: 100%;">
                            <div class="card-body">
                                <h5 class="card-title text-center">กราฟการชำระค่าเทอม</h5><br><br><br>
                                <canvas id="paymentChart" style="width: 100%; height: 400px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Card for Recent Activities -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">
                            <h3 class="card-title">
                                ข้อมูลการชำระเงิน
                                ภาคเรียนที่
                                <select id="termDropdown" class="form-select" style="display:inline-block; width:auto;">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                </select>
                                ปีการศึกษา
                                <select id="yearDropdown" class="form-select" style="display:inline-block; width:auto;">
                                    <option value="2567">2567</option>
                                    <option value="2568">2568</option>
                                    <option value="2569">2569</option>
                                    <option value="2570">2570</option>
                                </select>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-4">
                                    <h5 class="font-weight-bold" style="color: rgba(255, 99, 132, 1);">
                                        จำนวนนักศึกษาที่โอนผ่านธนาคาร</h5>
                                    <h3 id="recent-deposits" class="font-size-lg">0 คน</h3>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="font-weight-bold" style="color: rgba(54, 162, 235, 1);">
                                        จำนวนนักศึกษาที่ผ่อนชำระ</h5>
                                    <h3 id="recent-withdrawals" class="font-size-lg">0 คน</h3>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="font-weight-bold" style="color: rgba(0, 128, 0, 1);">
                                        จำนวนนักศึกษาที่ชำระเงินสด</h5>
                                    <h3 id="recent-borrowings" class="font-size-lg">0 คน</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- /.content-wrapper -->

            <!-- Add this script tag at the end of your body tag -->
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
            // Data and functions for the page

            // Format date in Thai
            function formatDateThai(date) {
                const monthsThai = [
                    "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                    "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
                ];
                const day = date.getDate();
                const month = monthsThai[date.getMonth()];
                const year = date.getFullYear() + 543; // Convert to Buddhist year
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return `${day} ${month} ${year} ${hours}:${minutes}:${seconds}`;
            }

            function updateDateTime() {
                const now = new Date();
                document.getElementById('currentDateTime').innerText = formatDateThai(now);
            }

            // Update date and time every second
            setInterval(updateDateTime, 1000);
            // Set initial date and time
            updateDateTime();

            // Create initial student chart
            const registrationData = {
                '2567': {
                    '1': [0, 0, 0, 0, 0], // Placeholder data
                    '2': [0, 0, 0, 0, 0] // Placeholder data
                }
            };

            // Create student chart
            const ctx = document.getElementById('studentChart').getContext('2d');
            const studentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ปวช.1', 'ปวช.2', 'ปวช.3', 'ปวส.1', 'ปวส.2'],
                    datasets: [{
                        label: 'ภาคเรียนที่ 1',
                        data: registrationData['2567']['1'],
                        backgroundColor: 'rgba(255, 45, 33, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }, {
                        label: 'ภาคเรียนที่ 2',
                        data: registrationData['2567']['2'],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ระดับชั้นปี'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'นักศึกษา (คน)'
                            },
                            suggestedMax: Math.max(...registrationData['2567']['1'], ...registrationData['2567']
                                ['2']) + 9
                        }
                    }
                }
            });

            // Update chart function
            function updateChart() {
                const selectedYear = document.getElementById('academicYear').value;

                // AJAX request to fetch data
                $.getJSON(`../fetch/total_registered_students.php?school_year=${selectedYear}`, function(data) {
                    // Update chart data
                    studentChart.data.datasets[0].data = data['1']; // Data for Semester 1
                    studentChart.data.datasets[1].data = data['2']; // Data for Semester 2
                    studentChart.options.plugins.title.text =
                        `กราฟนักศึกษาลงทะเบียน ปีการศึกษา ${selectedYear}`;
                    studentChart.update();
                });
            }

            // Event listener for dropdown change
            document.getElementById('academicYear').addEventListener('change', updateChart);

            // Initial chart load
            updateChart();
            // Create payment chart
            document.addEventListener('DOMContentLoaded', function() {
                fetch('../fetch/fetch_tuition_payment.php')
                    .then(response => response.json())
                    .then(data => {
                       // หากข้อมูลว่าง ให้แสดงปีปัจจุบันและอีก 3 ปีถัดไป
                        const currentYear = new Date().getFullYear() + 543; // ปีปัจจุบันของไทย
                        const labels = data.length > 0 ? data.map(item => item.school_year) : [currentYear, currentYear + 1, currentYear + 2, currentYear + 3];
                        const bankTransferData = data.length > 0 ? data.map(item => item.bank_transfer) : [0, 0, 0, 0];
                        const installmentPaymentData = data.length > 0 ? data.map(item => item.installment_payment) : [0, 0, 0, 0];
                        const cashPaymentData = data.length > 0 ? data.map(item => item.cash_payment) : [0, 0, 0, 0];

                        // หาค่าสูงสุด หากไม่มีข้อมูล ให้ใช้ 10,000 บาทเป็นค่าสูงสุด
                        const allData = [...bankTransferData, ...installmentPaymentData, ...cashPaymentData];
                        const maxValue = Math.max(...allData);
                        const maxY = allData.length > 0 ? Math.ceil((maxValue + 500)/1000) * 1000 : 10000; // Set maximum value

                        // Create the chart
                        const ctx = document.getElementById('paymentChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                        label: 'โอนผ่านธนาคาร',
                                        data: bankTransferData,
                                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'ผ่อนชำระ',
                                        data: installmentPaymentData,
                                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderWidth: 1
                                    },
                                    {
                                        label: 'ชำระเงินสด',
                                        data: cashPaymentData,
                                        backgroundColor: 'rgba(0, 255, 0, 0.7)',
                                        borderColor: 'rgba(0, 255, 0, 1)',
                                        borderWidth: 1
                                    }
                                ]
                            },
                            options: {
                                scales: {
                                    x: {
                                        title: {
                                            display: true,
                                            text: 'ปีการศึกษา'
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        max: maxY, 
                                        title: {
                                            display: true,
                                            text: 'จำนวนเงิน(บาท)'
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error fetching data:', error));
            });

            // Fetch and update statistics
            $(document).ready(function() {
                $.getJSON('../fetch/fetch_values_data.php', function(data) {
                    $('#total-deposits').text(Number(data.total_students).toLocaleString());
                    $('#total-withdrawals').text(Number(data.total_registered_students)
                        .toLocaleString());
                    $('#total-borrowings').text(Number(data.total_students_paid).toLocaleString());
                    $('#total-balance').text(Number(data.total_tuition_paid).toLocaleString());
                });
            });

            $(document).ready(function() {
                function fetchStatistics(semester, school_year) {
                    $.post('../fetch/payment_information.php', {
                        semester: semester,
                        school_year: school_year
                    }, function(data) {
                        if (!data.error) {
                            $('#recent-deposits').text(Number(data.bank_transfer).toLocaleString() +
                                ' คน');
                            $('#recent-withdrawals').text(Number(data.installment_payment)
                                .toLocaleString() + ' คน');
                            $('#recent-borrowings').text(Number(data.cash_payment).toLocaleString() +
                                ' คน');
                        } else {
                            console.error(data.error);
                        }
                    }, 'json');
                }

                // Call fetchStatistics when the page loads with default values
                fetchStatistics($('#termDropdown').val(), $('#yearDropdown').val());

                // Add event listeners for the dropdowns
                $('#termDropdown, #yearDropdown').change(function() {
                    const semester = $('#termDropdown').val();
                    const school_year = $('#yearDropdown').val();
                    fetchStatistics(semester, school_year);
                });
            });
            </script>
        </div><!-- /.container-fluid -->
    </section><!-- /.content -->
</div><!-- /.content-wrapper -->
