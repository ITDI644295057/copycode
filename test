<?php
header('Content-Type: application/json');

// เชื่อมต่อกับฐานข้อมูล
require_once('../config/connect.php');

try {
    // ฟังก์ชันสำหรับดึงข้อมูล
    function fetchData($query, $connection) {
        $stmt = $connection->prepare($query);
        $stmt->execute();
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    // Query 1: จำนวนนักศึกษาทั้งหมด
    $query1 = "SELECT COUNT(*) AS total_students FROM student";
    $total_students = fetchData($query1, $condb);

    // Query 2: จำนวนนักศึกษาลงทะเบียน
    $query2 = "SELECT COUNT(DISTINCT r.student_id) AS total_registered_students
               FROM registration r
               JOIN student s ON r.student_id = s.student_id
               WHERE r.registration_status = 'succeed'";
    $total_registered_students = fetchData($query2, $condb);

    // Query 3: จำนวนนักศึกษาชำระเงิน
    $query3 = "SELECT COUNT(DISTINCT student.student_id) AS total_students_paid
               FROM student
               JOIN registration ON student.student_id = registration.student_id
               JOIN tuition_payment_slip ON registration.registration_id = tuition_payment_slip.registration_id
               JOIN payment ON tuition_payment_slip.tuition_payment_slip_number = payment.tuition_payment_slip_number
               WHERE payment.payment_status = 'succeed'";
    $total_students_paid = fetchData($query3, $condb);

    // Query 4: จำนวนเงินชำระค่าเทอม
    $query4 = "SELECT SUM(DISTINCT tuition_payment_slip.total_money) AS total_tuition_paid
               FROM tuition_payment_slip
               JOIN payment ON tuition_payment_slip.tuition_payment_slip_number = payment.tuition_payment_slip_number
               WHERE payment.payment_status = 'succeed'";
    $total_tuition_paid = fetchData($query4, $condb);

    // ส่งข้อมูลเป็น JSON
    echo json_encode([
        'total_students' => $total_students['total_students'],
        'total_registered_students' => $total_registered_students['total_registered_students'],
        'total_students_paid' => $total_students_paid['total_students_paid'],
        'total_tuition_paid' => $total_tuition_paid['total_tuition_paid']
    ]);

} catch (PDOException $e) {
    echo json_encode(['error' => $e->getMessage()]);
}

// ปิดการเชื่อมต่อ
$condb = null;
?>
