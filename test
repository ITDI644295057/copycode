<?php
include('../config/connect.php');

$teacher_id=$_SESSION['teacher'];

// ดึงข้อมูลจากฐานข้อมูล
$sql = "SELECT login_date, login_time, ip_address, status_login FROM login_history WHERE teacher_id  = :teacher_id";
$stmt = $condb->prepare($sql);
$stmt->bindParam(':teacher_id', $teacher_id, PDO::PARAM_STR);
$stmt->execute();
$result = $stmt->fetchAll(PDO::FETCH_ASSOC);

// ฟังก์ชันแปลงวันที่เป็นรูปแบบไทย
function formatThaiDate($date) {
    $months = [
        "01" => "มกราคม", "02" => "กุมภาพันธ์", "03" => "มีนาคม",
        "04" => "เมษายน", "05" => "พฤษภาคม", "06" => "มิถุนายน",
        "07" => "กรกฎาคม", "08" => "สิงหาคม", "09" => "กันยายน",
        "10" => "ตุลาคม", "11" => "พฤศจิกายน", "12" => "ธันวาคม"
    ];
    $timestamp = strtotime($date);
    $day = date('j', $timestamp);
    $month = $months[date('m', $timestamp)];
    $year = date('Y', $timestamp) + 543; // แปลงปี
    return "$day $month $year";
}

function formatTime($time) {
    return date('H:i', strtotime($time));
}
?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ประวัติการเข้าใช้ระบบ</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Custom CSS -->
    <style>
    /* Page header style */
    .content-header {
        margin-bottom: 1rem;
    }

    /* Card styles */
    .usage-card {
        margin-bottom: 1rem;
        border-radius: .375rem;
        border: 1px solid #dee2e6;
        background-color: #ffffff;
        box-shadow: 0 0 0.5rem rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        position: relative;
    }

    .usage-card:hover {
        transform: scale(1.02);
    }

    .usage-card-body {
        padding: 1.25rem;
        display: flex;
        align-items: center;
    }

    .usage-icon {
        font-size: 2rem;
        margin-right: 1rem;
        color: #dc3545;
        /* Red color */
    }

    .usage-time {
        font-weight: bold;
        font-size: 1.2rem;
        color: #6c757d;
    }

    .usage-device {
        font-size: 1.1rem;
        color: #495057;
    }

    .device-icon {
        font-size: 1.5rem;
        position: absolute;
        right: 1rem;
        top: 1.25rem;
        color: #dc3545;
        /* Blue color */
    }

    .search-box {
        margin-top: 1rem;
    }


    .status-message {
        color: green;
        font-size: 1.3em;
        /* ปรับขนาดข้อความใหญ่ขึ้น */
        margin-right: 10px;
        /* ห่างจากขอบขวา 10px */
        margin-left: auto;
        /* ชิดขวา */
        margin-right: 10px;
        /* ห่างจากขอบขวา 10px */
    }
    </style>
</head>

<body>
    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="text-primary">ประวัติการเข้าใช้ระบบ</h1>
                    </div>
                    <div class="col-sm-6">
                        <div class="search-box">
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-input" placeholder="ค้นหา">
                                <div class="input-group-append">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <!-- Usage history cards -->
                <div class="row">
                    <div class="col-12">
                        <?php foreach ($result as $row) { 
                            // แปลงวันที่
                            $formattedDate = formatThaiDate($row['login_date']);
                            $formattedTime = formatTime($row['login_time']);
                            // ตรวจสอบ IP
                            $ipAddress = $row['ip_address'] == '::1' ? '127.0.0.1' : $row['ip_address'];
                        ?>
                        <div class="usage-card card" data-date="<?php echo $formattedDate; ?>"
                            data-time="<?php echo $formattedTime; ?>" data-ip="<?php echo $ipAddress; ?>">
                            <div class="usage-card-body">
                                <i class="fas fa-user-clock usage-icon"></i>
                                <div>
                                    <div class="usage-time">วันที่ <?php echo $formattedDate; ?> เวลา
                                        <?php echo $formattedTime; ?> น.</div>
                                    <div class="usage-device">IP : <?php echo $ipAddress; ?></div>
                                </div>
                                <div class="status-message">
                                    สถานะ : <?php echo $row['status_login']; ?>
                                </div>
                            </div>
                        </div>
                        <?php } ?>
                    </div>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->


    <!-- jQuery, Popper.js, and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    $(document).ready(function() {
        $('#search-input').on('input', function() {
            var query = $(this).val().toLowerCase();
            $('.usage-card').each(function() {
                var dateText = $(this).data('date').toLowerCase();
                var timeText = $(this).data('time').toLowerCase();
                var ipText = $(this).data('ip').toLowerCase();
                var match = dateText.indexOf(query) !== -1 || timeText.indexOf(query) !== -1 ||
                    ipText.indexOf(query) !== -1;
                $(this).toggle(match);
            });
        });
    });
    </script>
</body>

</html>
